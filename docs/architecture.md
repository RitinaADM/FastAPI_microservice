# Архитектура проекта

## Общая структура

Проект следует паттерну гексагональной архитектуры (портов и адаптеров) с четким разделением на три основных слоя:

1. **Доменный слой** - содержит всю бизнес-логику
2. **Слой приложения** - координирует выполнение бизнес-логики
3. **Инфраструктурный слой** - содержит адаптеры для взаимодействия с внешними системами

## Доменный слой

Доменный слой содержит всю бизнес-логику приложения и не зависит от других слоев. Это самое важное ядро системы, которое инкапсулирует бизнес-правила и логику предметной области.

### Сущности (Entities)

Сущности содержат данные и простую логику, связанную с этими данными. Они не должны содержать сложной бизнес-логики. Каждая сущность имеет уникальный идентификатор и жизненный цикл.

Пример: [Category](file:///c:/Users/dev/Documents/ritina_app/src/domain/entities/category.py#L7-L15) - представляет категорию товаров или услуг в системе.

### Объекты-значения (Value Objects)

Объекты-значения - это неизменяемые объекты, которые описываются только их значениями. Они не имеют уникального идентификатора и сравниваются по значению, а не по ссылке.

Пример: [CategoryId](file:///c:/Users/dev/Documents/ritina_app/src/domain/value_objects/category_id.py#L5-L16) - уникальный идентификатор категории.

### Доменные сервисы (Domain Services)

Доменные сервисы содержат сложную бизнес-логику, которая не помещается в сущности. Они оперируют сущностями и объектами-значениями, реализуя сложные бизнес-правила.

В текущем проекте доменные сервисы могут содержать логику, такую как:
- Сложные вычисления над категориями
- Бизнес-правила, которые затрагивают несколько сущностей
- Логика, которая не является естественной частью сущностей

Пример: [CategoryService](file:///c:/Users/dev/Documents/ritina_app/src/domain/services/category_service.py#L6-L17) содержит методы для валидации категорий и проверки возможности удаления.

### Порты (Ports)

Порты определяют интерфейсы для взаимодействия между слоями. Они позволяют слоям взаимодействовать друг с другом, не создавая жестких зависимостей.

#### Входящие порты (Inbound Ports)

Входящие порты определяют, какие операции может выполнять система. Они реализуются в слое приложения и представляют собой контракты для внешних систем.

Пример: [CategoryInputPort](file:///c:/Users/dev/Documents/ritina_app/src/domain/ports/inbound/category_input_port.py#L6-L26) определяет все операции, которые можно выполнить с категориями.

#### Исходящие порты (Outbound Ports)

Исходящие порты определяют, какие внешние зависимости нужны системе. Они реализуются в инфраструктурном слое и позволяют системе взаимодействовать с внешними ресурсами.

Примеры:
- [CategoryRepository](file:///c:/Users/dev/Documents/ritina_app/src/domain/ports/outbound/category_repository.py#L6-L26) - для работы с постоянным хранилищем
- [CategoryEventPublisher](file:///c:/Users/dev/Documents/ritina_app/src/domain/ports/outbound/category_event_publisher.py#L6-L17) - для публикации событий

### Исключения (Exceptions)

Исключения домена определяют возможные ошибки бизнес-логики. Они позволяют четко разделять технические и бизнес-ошибки.

Пример: [CategoryNotFoundError](file:///c:/Users/dev/Documents/ritina_app/src/domain/exceptions/category_exceptions.py#L1-L3) - возникает, когда категория не найдена.

## Слой приложения

Слой приложения координирует выполнение бизнес-логики, но не содержит саму бизнес-логику. Он реализует входящие порты и управляет потоком данных между внешними системами и доменом.

### Сценарии использования (Use Cases)

Сценарии использования реализуют входящие порты и координируют работу доменных объектов и сервисов. Они управляют транзакциями, безопасностью и другими сквозными аспектами.

Примеры:
- [CategoryReadUseCase](file:///c:/Users/dev/Documents/ritina_app/src/application/use_cases/category_read_use_case.py#L7-L32) реализует операции чтения категорий
- [CategoryWriteUseCase](file:///c:/Users/dev/Documents/ritina_app/src/application/use_cases/category_write_use_case.py#L7-L54) реализует операции записи категорий
- [CategoryStatisticsUseCase](file:///c:/Users/dev/Documents/ritina_app/src/application/use_cases/category_statistics_use_case.py#L6-L15) реализует получение статистики по категориям

В сценариях использования должна находиться логика координации, например:
- Получение данных из репозитория
- Вызов доменных сервисов для выполнения бизнес-логики
- Сохранение результатов
- Публикация событий

Сценарии использования не должны содержать сложную бизнес-логику - для этого есть доменные сервисы.

### Объекты передачи данных (DTOs)

DTO используются для передачи данных между слоями. Они позволяют избежать утечки доменных объектов в внешние системы.

Примеры:
- [CategoryDTO](file:///c:/Users/dev/Documents/ritina_app/src/application/dtos/category_dto.py#L1-L8)
- [CreateCategoryDTO](file:///c:/Users/dev/Documents/ritina_app/src/application/dtos/create_category_dto.py#L1-L7)

## Инфраструктурный слой

Инфраструктурный слой содержит адаптеры, реализующие исходящие порты. Он обеспечивает взаимодействие системы с внешним миром.

### Адаптеры (Adapters)

#### Входящие адаптеры (Inbound Adapters)

Входящие адаптеры принимают запросы от внешних систем и вызывают сценарии использования. Они преобразуют внешние запросы в формат, понятный слою приложения.

Пример: [CategoryController](file:///c:/Users/dev/Documents/ritina_app/src/infrastructure/adapters/inbound/rest/category_controller.py#L12-L102) (REST API) принимает HTTP-запросы и вызывает соответствующие сценарии использования.

#### Исходящие адаптеры (Outbound Adapters)

Исходящие адаптеры реализуют исходящие порты и взаимодействуют с внешними системами. Они преобразуют вызовы доменных портов в конкретные технологии.

Примеры:
- [MongoCategoryRepository](file:///c:/Users/dev/Documents/ritina_app/src/infrastructure/adapters/outbound/database/mongodb/category_repository_impl.py#L7-L79) (MongoDB) - реализует хранение данных с методами create и update
- [RabbitMQCategoryEventPublisher](file:///c:/Users/dev/Documents/ritina_app/src/infrastructure/adapters/outbound/message_bus/rabbitmq_publisher.py#L9-L87) (RabbitMQ) - реализует публикацию событий
- [RedisCacheAdapter](file:///c:/Users/dev/Documents/ritina_app/src/infrastructure/adapters/outbound/cache/redis_adapter.py#L8-L84) (Redis) - реализует кэширование
- [CachedCategoryRepository](file:///c:/Users/dev/Documents/ritina_app/src/infrastructure/adapters/outbound/cache/cached_category_repository.py#L8-L102) (декоратор) - добавляет кэширование к репозиторию

### Мапперы (Mappers)

Мапперы преобразуют данные между различными слоями. Они позволяют избежать жесткой связи между доменными объектами и DTO.

Пример: [category_mappers.py](file:///c:/Users/dev/Documents/ritina_app/src/infrastructure/mappers/category_mappers.py)

### Конфигурация (Config)

Конфигурация содержит настройки приложения. Она позволяет изменять поведение системы без изменения кода.

Пример: [Settings](file:///c:/Users/dev/Documents/ritina_app/src/infrastructure/config/settings.py#L5-L22)

### Внедрение зависимостей (DI)

Внедрение зависимостей настраивает связи между компонентами. Оно позволяет создавать слабосвязанные компоненты и упрощает тестирование.

Пример: [providers.py](file:///c:/Users/dev/Documents/ritina_app/src/infrastructure/di/providers.py)

## Поток данных

1. Внешняя система (например, REST клиент) вызывает входящий адаптер
2. Входящий адаптер вызывает сценарий использования
3. Сценарий использования координирует работу доменных объектов и сервисов
4. Для выполнения операций с внешними системами сценарий использования вызывает исходящие порты
5. Исходящие адаптеры выполняют операции с внешними системами

## Добавление нового функционала

Для добавления нового функционала следуйте этим шагам:

1. Определите новые сущности и объекты-значения в доменном слое
2. Создайте необходимые порты
3. Реализуйте бизнес-логику в доменных сервисах (если она сложная) или в сценариях использования
4. Создайте DTO в слое приложения
5. Реализуйте сценарии использования
6. Создайте адаптеры в инфраструктурном слое
7. Настройте внедрение зависимостей
8. Добавьте тесты
9. Обновите документацию